---
project: AncestorTree
path: docs/04-build/SPRINT-PLAN.md
type: build
version: 1.7.0
updated: 2026-02-26
owner: "@pm"
status: approved
---

# Sprint Plan - Gia Pháº£ Äiá»‡n Tá»­

## ğŸ“… Sprint Overview

```
Timeline: Feb 24 â†’ Apr 11, 2026 (7 weeks)

Sprint 1 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Week 1 (Feb 24-28) âœ… DONE
Sprint 2 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Week 2 (Mar 3-7)   âœ… DONE
Sprint 3 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Week 3 (Mar 10-14) âœ… DONE
Sprint 4 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Week 4 (Mar 17-21) âœ… DONE
Sprint 5 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Week 5 (Mar 24-28) âœ… DONE
Sprint 6 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Week 6 (Mar 31-Apr 4) âœ… DONE
Sprint 7 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Week 7 (Apr 7-11)  âœ… DONE
Sprint 7.5 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ (same day)         âœ… DONE
Sprint 8 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Week 8 (Apr 14-18) âœ… DONE
Sprint 9 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ Week 9+ (TBD)     ğŸ”„ PLANNING

Milestones:
â”œâ”€â”€ v0.1.0 Alpha    â†’ End Sprint 1    âœ…
â”œâ”€â”€ v0.5.0 Beta     â†’ End Sprint 2    âœ…
â”œâ”€â”€ v1.0.0 MVP      â†’ End Sprint 3    âœ…
â”œâ”€â”€ v1.1.0 Enhanced â†’ End Sprint 4    âœ…
â”œâ”€â”€ v1.2.0 Release  â†’ End Sprint 5    âœ…
â”œâ”€â”€ v1.3.0 Culture  â†’ End Sprint 6    âœ…
â”œâ”€â”€ v1.4.0 CauDuong â†’ End Sprint 7    âœ…
â”œâ”€â”€ v1.5.0 Relationsâ†’ End Sprint 7.5  âœ…
â”œâ”€â”€ v1.7.0 LocalDev+Security â†’ End Sprint 8 âœ…
â””â”€â”€ v2.0.0 Desktop  â†’ End Sprint 9    ğŸ”„ Planning
```

---

## ğŸƒ Sprint 1: Foundation (5 days) âœ…

**Dates:** Feb 24-28, 2026
**Goal:** Project setup + Database + Basic UI shell
**Version:** v0.1.0-alpha

### Tasks

| Day | Task | Hours | Owner | Status |
|-----|------|-------|-------|--------|
| **Day 1** | | | | |
| | Project scaffolding (Next.js 16, TypeScript) | 2h | @fullstack | âœ… |
| | Tailwind CSS 4 + shadcn/ui setup | 1h | @fullstack | âœ… |
| | Project structure (folders, configs) | 1h | @fullstack | âœ… |
| | Git repo setup, .gitignore, README | 1h | @fullstack | âœ… |
| **Day 2** | | | | |
| | Supabase project creation | 1h | @fullstack | âœ… |
| | Database schema (people, families, children) | 2h | @fullstack | âœ… |
| | RLS policies setup | 1h | @fullstack | âœ… |
| | Seed data (sample family) | 1h | @fullstack | âœ… |
| **Day 3** | | | | |
| | Supabase client setup | 1h | @fullstack | âœ… |
| | Auth provider (login/register) | 2h | @fullstack | âœ… |
| | Protected routes (middleware) | 1h | @fullstack | âœ… |
| | User profiles table | 1h | @fullstack | âœ… |
| **Day 4** | | | | |
| | Layout component (app-sidebar) | 2h | @fullstack | âœ… |
| | Navigation menu | 1h | @fullstack | âœ… |
| | Mobile responsive shell | 1h | @fullstack | âœ… |
| | Theme setup (colors, fonts) | 1h | @fullstack | âœ… |
| **Day 5** | | | | |
| | Homepage (dashboard with stats) | 1h | @fullstack | âœ… |
| | Deploy to Vercel | 1h | @fullstack | âœ… |
| | Environment variables setup | 0.5h | @fullstack | âœ… |
| | Sprint 1 testing & fixes | 2h | @fullstack | âœ… |
| | Documentation update | 0.5h | @fullstack | âœ… |

### Deliverables

- [x] Next.js 16 project running locally
- [x] Supabase database with schema
- [x] Auth flow (login/register/logout)
- [x] Basic layout with sidebar
- [x] Deployed to Vercel (staging)
- [x] README with setup instructions

### Exit Criteria

```
âœ… pnpm dev runs without errors
âœ… Can register & login
âœ… Database tables created
âœ… Vercel deployment working
âœ… Mobile responsive shell
```

---

## ğŸƒ Sprint 2: Core Data & Tree (5 days) âœ…

**Dates:** Mar 3-7, 2026
**Goal:** People CRUD + Family relationships + Basic tree
**Version:** v0.5.0-beta

### Tasks

| Day | Task | Hours | Owner | Status |
|-----|------|-------|-------|--------|
| **Day 1** | | | | |
| | Data layer (supabase-data.ts) | 2h | @fullstack | âœ… |
| | React Query setup | 1h | @fullstack | âœ… |
| | usePeople, useFamilies hooks | 2h | @fullstack | âœ… |
| **Day 2** | | | | |
| | People list page | 2h | @fullstack | âœ… |
| | Person card component | 1h | @fullstack | âœ… |
| | Search functionality | 1h | @fullstack | âœ… |
| | Filter by generation/chi | 1h | @fullstack | âœ… |
| **Day 3** | | | | |
| | Person detail page | 2h | @fullstack | âœ… |
| | Person edit form | 2h | @fullstack | âœ… |
| | Form validation (Zod) | 1h | @fullstack | âœ… |
| **Day 4** | | | | |
| | Family relationships UI | 2h | @fullstack | âœ… |
| | Parent selector (searchable) | 1h | @fullstack | âœ… |
| | Children management | 1h | @fullstack | âœ… |
| | Add new person flow | 1h | @fullstack | âœ… |
| **Day 5** | | | | |
| | Tree layout algorithm | 2h | @fullstack | âœ… |
| | Basic tree view component | 2h | @fullstack | âœ… |
| | Sprint 2 testing & fixes | 1h | @fullstack | âœ… |

### Deliverables

- [x] Full CRUD for people
- [x] Family relationships working
- [x] Search & filter functional
- [x] Basic tree renders correctly
- [x] Form validation

### Exit Criteria

```
âœ… Can add/edit/delete people
âœ… Can link parents/children
âœ… Search finds people by name
âœ… Tree shows family structure
âœ… Data persists in Supabase
```

---

## ğŸƒ Sprint 3: Interactive Tree & MVP (5 days) âœ…

**Dates:** Mar 10-14, 2026
**Goal:** Full interactive tree + Admin panel + MVP release
**Version:** v1.0.0-mvp

### Tasks

| Day | Task | Hours | Owner | Status |
|-----|------|-------|-------|--------|
| **Day 1** | | | | |
| | Tree zoom & pan | 2h | @fullstack | âœ… |
| | Tree node click â†’ detail panel | 1h | @fullstack | âœ… |
| | Collapse/expand branches | 2h | @fullstack | âœ… |
| **Day 2** | | | | |
| | Ancestor view filter | 1.5h | @fullstack | âœ… |
| | Descendant view filter | 1.5h | @fullstack | âœ… |
| | Tree minimap | 1h | @fullstack | âœ… |
| | Tree controls (zoom buttons) | 1h | @fullstack | âœ… |
| **Day 3** | | | | |
| | Admin panel - dashboard | 2h | @fullstack | âœ… |
| | User management page | 2h | @fullstack | âœ… |
| | Role assignment (admin/editor/viewer) | 1h | @fullstack | âœ… |
| **Day 4** | | | | |
| | Homepage with stats | 2h | @fullstack | âœ… |
| | Feature cards (navigation) | 1h | @fullstack | âœ… |
| | Mobile tree view optimization | 2h | @fullstack | âœ… |
| **Day 5** | | | | |
| | Performance testing | 1h | @fullstack | âœ… |
| | Bug fixes | 2h | @fullstack | âœ… |
| | MVP documentation | 1h | @fullstack | âœ… |
| | Error boundaries | 1h | @fullstack | âœ… |

### Deliverables

- [x] Interactive tree with zoom/pan
- [x] Collapse/expand working
- [x] Ancestor/descendant views
- [x] Admin panel functional
- [x] Homepage with stats
- [x] Error boundaries for all routes

### Exit Criteria

```
âœ… Tree is fully interactive
âœ… Admin can manage users
âœ… Mobile tree works
âœ… MVP feature complete
```

---

## ğŸƒ Sprint 4: Enhanced Features (5 days) âœ…

**Dates:** Mar 17-21, 2026
**Goal:** Directory + Memorial calendar + Contributions
**Version:** v1.1.0

### Tasks

| Day | Task | Hours | Owner | Status |
|-----|------|-------|-------|--------|
| **Day 1** | | | | |
| | Directory page (contact list) | 2h | @fullstack | âœ… |
| | Directory filters | 1h | @fullstack | âœ… |
| | Contact info display | 1h | @fullstack | âœ… |
| | Privacy controls | 1h | @fullstack | âœ… |
| **Day 2** | | | | |
| | Events table setup | 1h | @fullstack | âœ… |
| | Lunar calendar utility | 2h | @fullstack | âœ… |
| | Memorial calendar page | 2h | @fullstack | âœ… |
| **Day 3** | | | | |
| | Upcoming giá»— list | 1.5h | @fullstack | âœ… |
| | Calendar view component | 2h | @fullstack | âœ… |
| | Death lunar date input | 1.5h | @fullstack | âœ… |
| **Day 4** | | | | |
| | Contributions table | 1h | @fullstack | âœ… |
| | Contribution form (viewer) | 2h | @fullstack | âœ… |
| | Admin review page | 2h | @fullstack | âœ… |
| **Day 5** | | | | |
| | Approve/reject workflow | 1.5h | @fullstack | âœ… |
| | Contribution history | 1h | @fullstack | âœ… |
| | Sprint 4 testing & fixes | 2h | @fullstack | âœ… |
| | Documentation update | 0.5h | @fullstack | âœ… |

### Deliverables

- [x] Directory with contacts
- [x] Memorial calendar working
- [x] Lunar date support
- [x] Contribution workflow
- [x] Privacy settings

### Exit Criteria

```
âœ… Directory shows contacts (with privacy)
âœ… Memorial calendar displays giá»— dates
âœ… Lunar dates convert correctly
âœ… Viewers can submit contributions
âœ… Admins can approve/reject
```

---

## ğŸƒ Sprint 5: Polish & Release (5 days) âœ…

**Dates:** Mar 24-28, 2026
**Goal:** GEDCOM export + Book generator + Final polish
**Version:** v1.2.0-release

### Tasks

| Day | Task | Hours | Owner | Status |
|-----|------|-------|-------|--------|
| **Day 1** | | | | |
| | GEDCOM export utility | 2h | @fullstack | âœ… |
| | Export button & download | 1h | @fullstack | âœ… |
| | GEDCOM validation | 1h | @fullstack | âœ… |
| | Can Chi (zodiac) display | 1h | @fullstack | âœ… |
| **Day 2** | | | | |
| | Book generator utility | 2h | @fullstack | âœ… |
| | Book page (formatted view) | 2h | @fullstack | âœ… |
| | Print styles | 1h | @fullstack | âœ… |
| **Day 3** | | | | |
| | Media upload (photos) | 2h | @fullstack | âœ… |
| | Photo gallery component | 1.5h | @fullstack | âœ… |
| | Avatar upload | 1h | @fullstack | âœ… |
| | Supabase storage setup | 0.5h | @fullstack | âœ… |
| **Day 4** | | | | |
| | Performance optimization | 2h | @fullstack | âœ… |
| | SEO meta tags | 1h | @fullstack | âœ… |
| | Error boundaries | 1h | @fullstack | âœ… |
| | Loading states polish | 1h | @fullstack | âœ… |
| **Day 5** | | | | |
| | Final testing (all features) | 2h | @fullstack | âœ… |
| | Bug fixes | 1.5h | @fullstack | âœ… |
| | User documentation | 1h | @fullstack | âœ… |
| | Release notes | 0.5h | @fullstack | âœ… |

### Deliverables

- [x] GEDCOM export working
- [x] Book generator functional
- [x] Photo upload working
- [x] Performance optimized
- [x] Full documentation
- [x] v1.2.0 released

### Exit Criteria

```
âœ… GEDCOM exports valid file
âœ… Book view renders correctly
âœ… Photos upload & display
âœ… All features documented
âœ… Production stable
```

---

## ğŸƒ Sprint 6: Culture & Community (5 days) âœ…

**Dates:** Mar 31 - Apr 4, 2026
**Goal:** Achievement honors + Education fund + Family charter
**Version:** v1.3.0-culture

### Prerequisites (from Sprint 4-5)

> Sprint 6 has FK dependencies on `people` and `profiles` tables (Sprint 1-2) which are stable.
> Sprint 4-5 features are fully implemented.
>
> **Result:** Sprint 6 completed successfully on top of Sprint 4-5.

### Migration Strategy

> **DO NOT** modify `database-setup.sql` directly. Create a separate migration file:
> `frontend/supabase/sprint6-migration.sql` with all new tables, RLS policies, and indexes.
>
> **Data layer:** Split new functions into separate modules to avoid bloating `supabase-data.ts`:
> - `supabase-data-achievements.ts`
> - `supabase-data-fund.ts`
> - `supabase-data-charter.ts`

### Tasks

| Day | Task | Hours | Owner | Status |
|-----|------|-------|-------|--------|
| **Day 1: Database + Types + Data Layer** | | | | |
| | DB migration: CREATE tables (achievements, fund_transactions, scholarships, clan_articles) | 1.5h | @fullstack | âœ… |
| | DB migration: RLS policies for 4 new tables | 1h | @fullstack | âœ… |
| | DB migration: Indexes (person, category, status, date) | 0.5h | @fullstack | âœ… |
| | TypeScript types: Achievement, FundTransaction, Scholarship, ClanArticle + enums | 1h | @fullstack | âœ… |
| | Data layer: supabase-data-achievements.ts (~8 functions) | 1.5h | @fullstack | âœ… |
| | Data layer: supabase-data-fund.ts (~8 functions) | 1.5h | @fullstack | âœ… |
| **Day 2: Data Layer (cont.) + Achievement UI** | | | | |
| | Data layer: supabase-data-charter.ts (~8 functions) | 1h | @fullstack | âœ… |
| | React Query hooks: use-achievements.ts, use-fund.ts, use-clan-articles.ts | 1.5h | @fullstack | âœ… |
| | Achievement honors page (featured + list) | 2h | @fullstack | âœ… |
| | Achievement category filters (hoc_tap, su_nghiep, cong_hien) | 1h | @fullstack | âœ… |
| | Achievement detail card component | 1h | @fullstack | âœ… |
| **Day 3: Fund Dashboard + Scholarships** | | | | |
| | Education fund dashboard (balance, stats) | 2h | @fullstack | âœ… |
| | Scholarship list with tabs (hoc_bong, khen_thuong) | 1.5h | @fullstack | âœ… |
| | Donation history & contribution form | 1.5h | @fullstack | âœ… |
| | Admin: achievement management CRUD | 2h | @fullstack | âœ… |
| **Day 4: Charter + Admin Pages** | | | | |
| | Family charter page with tabs (gia_huan, quy_uoc, loi_dan) | 2h | @fullstack | âœ… |
| | Rich text article display component | 1h | @fullstack | âœ… |
| | Admin: fund & scholarship management | 2h | @fullstack | âœ… |
| | Admin: charter article management CRUD | 1.5h | @fullstack | âœ… |
| **Day 5: Integration + Testing** | | | | |
| | Sidebar navigation update (3 new sections) | 0.5h | @fullstack | âœ… |
| | Homepage integration (honors + fund summary + featured charter) | 1.5h | @fullstack | âœ… |
| | Annual report views (achievements + fund) | 1h | @fullstack | âœ… |
| | Sprint 6 testing & fixes | 2h | @fullstack | âœ… |
| | Documentation update | 0.5h | @fullstack | âœ… |

### Hour Summary

| Day | Total | Focus |
|-----|-------|-------|
| Day 1 | 7h | DB migration + Types + Data layer (achievements, fund) |
| Day 2 | 6.5h | Data layer (charter) + Hooks + Achievement UI |
| Day 3 | 7h | Fund dashboard + Scholarships + Admin achievements |
| Day 4 | 6.5h | Charter page + Admin fund & charter |
| Day 5 | 5.5h | Integration + Testing + Docs |
| **Total** | **32.5h** | |

### Deliverables

- [x] DB migration file with 4 tables, RLS policies, indexes
- [x] TypeScript types + enums for all Sprint 6 entities
- [x] Data layer modules (3 files) + React Query hooks (3 files)
- [x] Achievement honors page with category filters
- [x] Education fund dashboard with balance tracking
- [x] Scholarship & reward management
- [x] Family charter page with 3 article categories
- [x] Admin CRUD for all 3 features
- [x] Homepage integration (honors + fund + charter)

### Exit Criteria

```
âœ… sprint6-migration.sql applies without errors
âœ… Achievements display with category filters
âœ… Fund dashboard shows balance and transactions
âœ… Scholarships can be created, approved, and paid
âœ… Charter articles display with category tabs
âœ… Admin can manage all new content
âœ… Sidebar shows 3 new navigation sections
âœ… pnpm build passes without errors
```

---

## ğŸ“Š Sprint Summary

| Sprint | Focus | Key Deliverables | LOC Est. | Status |
|--------|-------|------------------|----------|--------|
| **Sprint 1** | Foundation | Project setup, DB, Auth, Layout | ~2,000 | âœ… |
| **Sprint 2** | Core Data | CRUD, Relationships, Basic Tree | ~3,000 | âœ… |
| **Sprint 3** | MVP | Interactive Tree, Admin, Deploy | ~2,500 | âœ… |
| **Sprint 4** | Enhanced | Directory, Calendar, Contributions | ~2,500 | âœ… |
| **Sprint 5** | Polish | GEDCOM, Book, Photos, Release | ~2,000 | âœ… |
| **Sprint 6** | Culture | Honors, Fund, Scholarships, Charter | ~3,000 | âœ… |
| **Sprint 7** | Ceremony | Cáº§u Ä‘Æ°Æ¡ng rotation + DFS algorithm | ~1,500 | âœ… |
| **Sprint 7.5** | Relations | Family relations UX + tree filter | ~2,000 | âœ… |
| **Sprint 8** | LocalDev + Security | Supabase CLI + Docker + RLS hardening + middleware fix | ~1,200 | âœ… |
| **Sprint 9** | Desktop App | Electron + sql.js shim, SQLite DB, 3-platform installer | ~1,800 est. | ğŸ”„ |
| **Total** | | | **~21,500** | |

---

## ğŸ“‹ Feature Completion Matrix

| Feature | S1 | S2 | S3 | S4 | S5 | S6 | S7 | S7.5 | S8 | Status |
|---------|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:----:|:--:|:------:|
| Project Setup | âœ… | | | | | | | | | DONE |
| Database Schema | âœ… | | | | | | | | | DONE |
| Auth (Login/Register) | âœ… | | | | | | | | | DONE |
| Layout & Navigation | âœ… | | | | | | | | | DONE |
| People CRUD | | âœ… | | | | | | | | DONE |
| Family Relationships | | âœ… | | | | | | | | DONE |
| Search & Filter | | âœ… | | | | | | | | DONE |
| Basic Tree View | | âœ… | | | | | | | | DONE |
| Interactive Tree | | | âœ… | | | | | | | DONE |
| Admin Panel | | | âœ… | | | | | | | DONE |
| Homepage & Stats | | | âœ… | | | | | | | DONE |
| Directory | | | | âœ… | | | | | | DONE |
| Memorial Calendar | | | | âœ… | | | | | | DONE |
| Lunar Calendar | | | | âœ… | | | | | | DONE |
| Contributions | | | | âœ… | | | | | | DONE |
| GEDCOM Export | | | | | âœ… | | | | | DONE |
| Book Generator | | | | | âœ… | | | | | DONE |
| Photo Upload | | | | | âœ… | | | | | DONE |
| Error Boundaries | | | | | âœ… | | | | | DONE |
| Achievement Honors | | | | | | âœ… | | | | DONE |
| Education Fund | | | | | | âœ… | | | | DONE |
| Scholarships & Rewards | | | | | | âœ… | | | | DONE |
| Family Charter | | | | | | âœ… | | | | DONE |
| Cáº§u Ä‘Æ°Æ¡ng (rotation+DFS) | | | | | | | âœ… | | | DONE |
| FamilyRelationsCard | | | | | | | | âœ… | | DONE |
| Tree hierarchical layout | | | | | | | | âœ… | | DONE |
| Tree-scoped editor | | | | | | | | âœ… | | DONE |
| Local dev (Supabase CLI) | | | | | | | | | âœ… | DONE |
| Middleware auth guard | | | | | | | | | âœ… | DONE |
| RLS: profiles protected | | | | | | | | | âœ… | DONE |
| RLS: contact data private | | | | | | | | | âœ… | DONE |
| RLS: tables auth-gated | | | | | | | | | âœ… | DONE |
| Electron shell (Desktop) | | | | | | | | | | S9 |
| sql.js SQLite shim | | | | | | | | | | S9 |
| Offline installer (.dmg/.exe) | | | | | | | | | | S9 |

---

## ğŸ¯ Success Metrics

### Per Sprint

| Sprint | Metric | Target | Result |
|--------|--------|--------|--------|
| S1 | Project runs | âœ… No errors | PASS |
| S1 | Deployment | âœ… Vercel live | PASS |
| S2 | Data operations | âœ… CRUD works | PASS |
| S2 | Tree renders | âœ… 5 generations | PASS |
| S3 | Interactive tree | âœ… Zoom/pan/collapse | PASS |
| S3 | User management | âœ… Roles work | PASS |
| S4 | Calendar | âœ… Lunar dates correct | PASS |
| S4 | Contributions | âœ… Workflow complete | PASS |
| S5 | GEDCOM | âœ… Valid export | PASS |
| S5 | Error boundaries | âœ… All routes covered | PASS |
| S6 | DB migration | âœ… sprint6-migration.sql applies cleanly | PASS |
| S6 | Achievements | âœ… Honors page with filters | PASS |
| S6 | Fund | âœ… Dashboard with balance | PASS |
| S6 | Charter | âœ… Articles with categories | PASS |
| S6 | Build | âœ… pnpm build passes | PASS |
| S7 | DB migration | âœ… cau-duong-migration.sql applies cleanly | PASS |
| S7 | DFS algorithm | âœ… Correct preorder traversal | PASS |
| S7 | Public schedule | âœ… 4 ceremonies/year with status badges | PASS |
| S7 | Admin panel | âœ… Pool + assignment + delegation management | PASS |
| S7.5 | FamilyRelationsCard | âœ… Parents/siblings/spouses/children | PASS |
| S7.5 | Tree hierarchical layout | âœ… Bottom-up subtree width algorithm | PASS |
| S7.5 | Tree branch filter | âœ… ?root= URL parameter working | PASS |
| S7.5 | Tree-scoped editor | âœ… RLS + admin UI complete | PASS |

### Final Release

| Metric | Target | Result |
|--------|--------|--------|
| **Features complete** | 100% of MVP + v1.5 | âœ… DONE |
| **Bugs** | 0 critical, <5 minor | âœ… 0 critical |
| **Mobile** | 100% responsive | âœ… DONE |
| **Build** | pnpm build + lint clean | âœ… PASS |

---

## ğŸ”§ Technical Dependencies

### Sprint 1 Prerequisites
- Node.js 22+
- pnpm
- Supabase account
- Vercel account
- GitHub repository

### Key Libraries (Actual)

| Library | Version | Sprint | Notes |
|---------|---------|--------|-------|
| Next.js | 16.1.6 | S1 | |
| React | 19.2.3 | S1 | |
| TypeScript | 5.x | S1 | |
| Tailwind CSS | 4.x | S1 | |
| shadcn/ui | 3.8.5 | S1 | |
| @supabase/supabase-js | 2.97.0 | S1 | |
| @supabase/ssr | 0.8.0 | S1 | Server-side auth |
| React Query | 5.90.21 | S2 | |
| Zod | 4.3.6 | S2 | |
| react-hook-form | 7.71.2 | S2 | |
| Framer Motion | 12.34.3 | S3 | |
| Lucide React | 0.575.0 | S1 | Icons |

> **Note:** Zustand 5.0.11 is installed but not actively used. State management is handled via React Context (AuthProvider) + React Query cache.

---

---

## ğŸƒ Sprint 7: Lá»‹ch Cáº§u Ä‘Æ°Æ¡ng (5 days) ğŸ”„

**Dates:** Apr 7-11, 2026
**Goal:** Ceremony rotation schedule â€” phÃ¢n cÃ´ng xoay vÃ²ng chá»§ lá»… Cáº§u Ä‘Æ°Æ¡ng
**Version:** v1.4.0
**BRD Coverage:** FR-1501~1507

### Business Context

Cáº§u Ä‘Æ°Æ¡ng lÃ  nghi lá»… cÃºng tá»• tiÃªn xoay vÃ²ng trong dÃ²ng há»:
- **4 lá»…/nÄƒm:** Táº¿t NguyÃªn ÄÃ¡n, Ráº±m thÃ¡ng GiÃªng (15/1 AL), Giá»— tá»• Can ThÄƒng (15/3 AL), Ráº±m thÃ¡ng Báº£y (15/7 AL)
- **NgÆ°á»i Ä‘á»§ Ä‘iá»u kiá»‡n:** Nam giá»›i Ä‘Ã£ láº­p gia Ä‘Ã¬nh, dÆ°á»›i 70 tuá»•i Ã¢m, tá»« Ä‘á»i 12 trá»Ÿ xuá»‘ng
- **Thá»© tá»± xoay vÃ²ng:** DFS preorder cá»§a cÃ¢y gia pháº£ tá»« tá»• tÃ´ng, Ä‘á»i trÃªn trÆ°á»›c, trong má»—i Ä‘á»i theo thá»© tá»± gia Ä‘Ã¬nh (sort_order)
- **Tuá»•i Ã¢m:** `currentYear - birthYear + 1` (cÃ¡ch tÃ­nh tuá»•i Viá»‡t Nam)
- **Chu ká»³:** Sau khi xoay háº¿t 1 vÃ²ng sáº½ báº¯t Ä‘áº§u láº¡i tá»« Ä‘áº§u

### Database Design

**Tables má»›i:**

```sql
cau_duong_pools          -- Cáº¥u hÃ¬nh nhÃ³m xoay vÃ²ng
â”œâ”€â”€ id (UUID PK)
â”œâ”€â”€ name                 -- VD: "NhÃ¡nh Ã´ng Äáº·ng ÄÃ¬nh NhÃ¢n"
â”œâ”€â”€ ancestor_id          -- FK â†’ people (tá»• tÃ´ng gá»‘c cá»§a nhÃ³m)
â”œâ”€â”€ min_generation       -- Äá»i tá»‘i thiá»ƒu (VD: 12)
â”œâ”€â”€ max_age_lunar        -- Tuá»•i Ã¢m tá»‘i Ä‘a (máº·c Ä‘á»‹nh: 70)
â”œâ”€â”€ description
â””â”€â”€ is_active

cau_duong_assignments    -- PhÃ¢n cÃ´ng tá»«ng lá»…
â”œâ”€â”€ id (UUID PK)
â”œâ”€â”€ pool_id              -- FK â†’ cau_duong_pools
â”œâ”€â”€ year                 -- NÄƒm dÆ°Æ¡ng lá»‹ch
â”œâ”€â”€ ceremony_type        -- ENUM: tet | ram_thang_gieng | gio_to | ram_thang_bay
â”œâ”€â”€ host_person_id       -- NgÆ°á»i Ä‘Æ°á»£c phÃ¢n cÃ´ng
â”œâ”€â”€ actual_host_person_id -- NgÆ°á»i thá»±c sá»± thá»±c hiá»‡n (náº¿u á»§y quyá»n)
â”œâ”€â”€ status               -- ENUM: scheduled | completed | delegated | rescheduled | cancelled
â”œâ”€â”€ scheduled_date       -- NgÃ y dá»± kiáº¿n (DATE)
â”œâ”€â”€ actual_date          -- NgÃ y thá»±c hiá»‡n (DATE, náº¿u Ä‘á»•i)
â”œâ”€â”€ reason               -- LÃ½ do á»§y quyá»n / Ä‘á»•i ngÃ y
â”œâ”€â”€ notes
â”œâ”€â”€ rotation_index       -- Vá»‹ trÃ­ trong DFS list khi phÃ¢n cÃ´ng (Ä‘á»ƒ theo dÃµi vÃ²ng xoay)
â””â”€â”€ UNIQUE(pool_id, year, ceremony_type)
```

**Migration file:** `frontend/supabase/cau-duong-migration.sql`

### Algorithm: DFS Preorder Traversal

```
Má»¥c tiÃªu: XÃ¡c Ä‘á»‹nh thá»© tá»± xoay vÃ²ng theo cÃ¢y gia pháº£

Input:
  - ancestor_id: UUID cá»§a tá»• tÃ´ng nhÃ³m Cáº§u Ä‘Æ°Æ¡ng
  - families: {father_id â†’ [family]} (sorted by sort_order)
  - children: {family_id â†’ [child]} (sorted by sort_order)

Algorithm (DFS preorder):
  1. Stack = [ancestor_id]
  2. While stack not empty:
     a. current = stack.pop()
     b. Náº¿u current lÃ  male, married â†’ thÃªm vÃ o eligible_list
     c. Láº¥y táº¥t cáº£ families mÃ  father_id = current (sort by sort_order)
     d. Vá»›i má»—i family (theo thá»© tá»± ngÆ°á»£c Ä‘á»ƒ push Ä‘Ãºng thá»© tá»±):
        - Láº¥y children cá»§a family (sort by sort_order)
        - Push children vÃ o stack (thá»© tá»± ngÆ°á»£c)
  3. Lá»c eligible_list: gender=1, is_living, generation>=min_gen, ageLunar<max_age

Rotation logic:
  - next_rotation_index = (last_assignment.rotation_index + 1) % eligible_count
  - eligible_list[next_rotation_index] = ngÆ°á»i Ä‘Æ°á»£c phÃ¢n cÃ´ng tiáº¿p theo
```

**Algorithm file:** `frontend/src/lib/supabase-data-cau-duong.ts`

### Tasks

| Day | Task | Hours | Owner | Status |
|-----|------|-------|-------|--------|
| **Day 1: Database + Types** | | | | |
| | Táº¡o `cau-duong-migration.sql` (tables + RLS) | 2h | @fullstack | âœ… |
| | ThÃªm types vÃ o `src/types/index.ts` | 1h | @fullstack | âœ… |
| | Run migration trÃªn Supabase | 0.5h | @fullstack | âœ… |
| **Day 2: Data Layer + Hooks** | | | | |
| | Táº¡o `src/lib/supabase-data-cau-duong.ts` | 3h | @fullstack | âœ… |
| | Implement DFS algorithm (`buildDFSOrder`) | 1h | @fullstack | âœ… |
| | Táº¡o `src/hooks/use-cau-duong.ts` | 1h | @fullstack | âœ… |
| **Day 3: Public View** | | | | |
| | Táº¡o `/cau-duong/page.tsx` â€” xem lá»‹ch phÃ¢n cÃ´ng | 2h | @fullstack | âœ… |
| | Tab 1: Lá»‹ch phÃ¢n cÃ´ng nÄƒm (4 lá»…, cÃ³ status badge) | 1h | @fullstack | âœ… |
| | Tab 2: Danh sÃ¡ch thÃ nh viÃªn Ä‘á»§ Ä‘iá»u kiá»‡n (DFS order) | 1h | @fullstack | âœ… |
| | ThÃªm error.tsx + loading.tsx | 0.5h | @fullstack | âœ… |
| **Day 4: Admin Panel** | | | | |
| | Táº¡o `/admin/cau-duong/page.tsx` | 3h | @fullstack | âœ… |
| | Form táº¡o/sá»­a pool (tá»• tÃ´ng, Ä‘á»i, tuá»•i) | 1h | @fullstack | âœ… |
| | NÃºt phÃ¢n cÃ´ng tá»± Ä‘á»™ng + manual assign | 1h | @fullstack | âœ… |
| | Xá»­ lÃ½ á»§y quyá»n (delegation form) | 1h | @fullstack | âœ… |
| | Xá»­ lÃ½ Ä‘á»•i ngÃ y (reschedule form) | 0.5h | @fullstack | âœ… |
| | Ghi nháº­n hoÃ n thÃ nh (mark complete) | 0.5h | @fullstack | âœ… |
| **Day 5: Navigation + Docs** | | | | |
| | ThÃªm "Cáº§u Ä‘Æ°Æ¡ng" vÃ o sidebar navigation | 0.5h | @fullstack | âœ… |
| | Update `docs/02-design/technical-design.md` | 1h | @pm | âœ… |
| | Update `CLAUDE.md` vá»›i Sprint 7 info | 0.5h | @pm | âœ… |
| | Verify build passes (`pnpm build`) | 1h | @fullstack | âœ… |

### Acceptance Criteria

| ID | Criteria | Status |
|----|----------|--------|
| AC-S7-01 | Admin cÃ³ thá»ƒ táº¡o nhÃ³m Cáº§u Ä‘Æ°Æ¡ng vá»›i cáº¥u hÃ¬nh Ä‘á»i/tuá»•i | âœ… |
| AC-S7-02 | Há»‡ thá»‘ng tÃ­nh Ä‘Ãºng danh sÃ¡ch Ä‘á»§ Ä‘iá»u kiá»‡n theo tuá»•i Ã¢m | âœ… |
| AC-S7-03 | Thá»© tá»± danh sÃ¡ch Ä‘Ãºng theo DFS preorder cÃ¢y gia pháº£ | âœ… |
| AC-S7-04 | Admin phÃ¢n cÃ´ng tá»± Ä‘á»™ng chá»n ngÆ°á»i tiáº¿p theo trong vÃ²ng xoay | âœ… |
| AC-S7-05 | Viewer xem Ä‘Æ°á»£c lá»‹ch phÃ¢n cÃ´ng 4 lá»…/nÄƒm vá»›i status | âœ… |
| AC-S7-06 | á»¦y quyá»n: ghi nháº­n ngÆ°á»i á»§y quyá»n + ngÆ°á»i thá»±c hiá»‡n + lÃ½ do | âœ… |
| AC-S7-07 | Äá»•i ngÃ y: cáº­p nháº­t actual_date, lÃ½ do, status=rescheduled | âœ… |
| AC-S7-08 | VÃ²ng xoay tá»± Ä‘á»™ng reset sau khi háº¿t 1 chu ká»³ | âœ… |

### File Structure

```
frontend/
â”œâ”€â”€ supabase/
â”‚   â””â”€â”€ cau-duong-migration.sql   âœ… Created
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â””â”€â”€ index.ts              âœ… Added CauDuong types
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â””â”€â”€ supabase-data-cau-duong.ts  âœ… Created
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â””â”€â”€ use-cau-duong.ts      âœ… Created
â”‚   â””â”€â”€ app/(main)/
â”‚       â”œâ”€â”€ cau-duong/
â”‚       â”‚   â”œâ”€â”€ page.tsx          âœ… Created
â”‚   â”‚   â”œâ”€â”€ error.tsx         âœ… Created
â”‚   â”‚   â””â”€â”€ loading.tsx       âœ… Created
â”‚       â””â”€â”€ admin/
â”‚           â””â”€â”€ cau-duong/
â”‚               â””â”€â”€ page.tsx      âœ… Created
â””â”€â”€ src/components/layout/
    â””â”€â”€ app-sidebar.tsx           âœ… Updated (nav item added)
```

### Dependencies

- Requires: Sprint 1-6 complete (DB tables `people`, `families`, `children` with `sort_order`)
- Requires: `is_living`, `gender`, `generation`, `birth_year` fields on `people` table
- Requires: `sort_order` on `families` and `children` tables (Sprint 3)

---

---

## ğŸƒ Sprint 7.5: Family Relations UX âœ…

**Dates:** Feb 25, 2026 (same day as Sprint 7)
**Goal:** Cáº£i thiá»‡n UX quan há»‡ gia Ä‘Ã¬nh + Tree layout phÃ¢n nhÃ¡nh + Tree-scoped editor

### Tasks

| # | Task | Hours | Status |
|---|------|:-----:|:------:|
| 1 | `PersonRelations` interface + `getPersonRelations()` data layer | 1h | âœ… |
| 2 | `usePersonRelations()` + family mutation hooks | 1h | âœ… |
| 3 | `FamilyRelationsCard` component (parents/siblings/spouses/children + AddRelationDialog) | 2h | âœ… |
| 4 | Parent selection on `/people/new` (PersonCombobox for Cha/Máº¹) | 1h | âœ… |
| 5 | Hierarchical tree layout engine (bottom-up subtree width â†’ top-down X assignment) | 2h | âœ… |
| 6 | Branch filter `?root=<id>` URL state + DFS from root | 1h | âœ… |
| 7 | Tree-scoped editor: `edit_root_person_id` + `is_person_in_subtree()` RLS (FR-507~510) | 2h | âœ… |
| 8 | Admin UI: TreeMappingDialog (linked_person + edit scope) | 1h | âœ… |

### Deliverables

- âœ… `/people/[id]` â€” FamilyRelationsCard with add relation dialog
- âœ… `/people/new` â€” Parent selection (auto-fill generation)
- âœ… `/tree` â€” Hierarchical layout + branch filter + `?root=` URL
- âœ… `/admin/users` â€” Tree mapping dialog (linked_person, edit_root)
- âœ… `sprint75-migration.sql` â€” `is_person_in_subtree()` + RLS policies

---

## ğŸƒ Sprint 8: Local Development Mode + Security Hardening âœ…

**Dates:** Feb 26, 2026
**Goal:** Local dev offline + vÃ¡ lá»— há»•ng báº£o máº­t dá»¯ liá»‡u cÃ¡ nhÃ¢n
**Version:** v1.7.0

### Business Context

Nhiá»u thÃ nh viÃªn dÃ²ng há» khÃ´ng rÃ nh ká»¹ thuáº­t, khÃ´ng muá»‘n Ä‘Äƒng kÃ½ dá»‹ch vá»¥ cloud.
Supabase CLI + Docker cho phÃ©p cháº¡y **toÃ n bá»™ stack offline** vá»›i zero code change.

### Prerequisites

- Docker Desktop (2GB+ RAM)
- Node.js 18+, pnpm
- Sprints 1-7.5 complete (all migrations ready)

### Tasks â€” Part A: Local Development

| # | Task | Hours | Status |
|---|------|:-----:|:------:|
| 1 | Create `supabase/config.toml` (ports, auth, storage bucket) | 0.5h | âœ… |
| 2 | Move SQL files to `supabase/migrations/` (timestamped, single source of truth) | 0.5h | âœ… |
| 3 | Fix `handle_new_user()` trigger â€” add `SET search_path = public` | 0.5h | âœ… |
| 4 | Create `supabase/seed.sql` (demo family tree + auth users with bcrypt + auth.identities) | 1.5h | âœ… |
| 5 | Create `scripts/local-setup.mjs` (cross-platform Node.js setup script) | 1h | âœ… |
| 6 | Update `package.json` (`local:setup/start/stop/reset` scripts) | 0.25h | âœ… |
| 7 | Update `.env.local.example` (local-first defaults) | 0.25h | âœ… |
| 8 | Create `docs/04-build/LOCAL-DEVELOPMENT.md` (detailed guide) | 1h | âœ… |
| 9 | Update `README.md` + `CLAUDE.md` | 0.5h | âœ… |
| 10 | End-to-end test: `supabase start` â†’ `pnpm dev` â†’ login â†’ browse | 0.5h | âœ… |

### Tasks â€” Part B: Security Hardening

> Tham kháº£o: https://anninhthudo.vn â€” rá»§i ro lá»™ lá»c dá»¯ liá»‡u cÃ¡ nhÃ¢n trÃªn cÃ¡c ná»n táº£ng gia pháº£ Viá»‡t Nam

| # | Task | Issue | Hours | Status |
|---|------|-------|:-----:|:------:|
| 11 | Rename `proxy.ts` â†’ `middleware.ts` (Next.js requires exact filename) | SEC-00: middleware was never executed | 0.25h | âœ… |
| 12 | Extend middleware `authRequiredPaths` to cover ALL `(main)` routes | SEC-01: only `/admin` + `/contributions` were protected | 0.25h | âœ… |
| 13 | Fix `profiles` RLS `SELECT USING (true)` â†’ `auth.uid() IS NOT NULL` | SEC-02: any anonymous request could list all user emails + roles | 0.5h | âœ… |
| 14 | Fix `people` RLS: strip contact fields from public/anon reads + add admin-only policy | SEC-03: phone/email/zalo/address exposed to unauthenticated API calls | 0.5h | âœ… |
| 15 | Change `people.privacy_level` default `0` (public) â†’ `1` (members only) | SEC-04: new entries accidentally public | 0.25h | âœ… |
| 16 | Backfill: set `privacy_level = 1` for living members with contact data | SEC-05: existing data protection | 0.25h | âœ… |
| 17 | Restrict `families`/`children`/`events`/`media` SELECT to authenticated users | SEC-06: structural data crawlable without login | 0.5h | âœ… |
| 18 | Add `CONTACT_FIELDS` constant in `supabase-data.ts` (code-level documentation) | Defense in depth | 0.25h | âœ… |
| 19 | Increase minimum password length 6 â†’ 8 chars in register page | SEC-07: weak password policy | 0.25h | âœ… |
| 20 | Add migration `20260226000005_security_hardening.sql` | All DB-level fixes in one migration | 0.5h | âœ… |

### Acceptance Criteria

**Part A â€” Local Development:**
- [x] `pnpm local:setup` khá»Ÿi cháº¡y Docker containers + táº¡o `.env.local`
- [x] `pnpm dev` â†’ login `admin@giapha.local` / `admin123` thÃ nh cÃ´ng
- [x] CÃ¢y gia pháº£ hiá»ƒn thá»‹ 15-20 thÃ nh viÃªn demo
- [x] Táº¡o sá»± kiá»‡n, search thÃ nh viÃªn, CRUD hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng
- [x] Supabase Studio (`http://localhost:54323`) truy cáº­p Ä‘Æ°á»£c
- [x] `supabase db reset` xoÃ¡ sáº¡ch + seed láº¡i thÃ nh cÃ´ng
- [x] `pnpm build` váº«n pass (cloud mode khÃ´ng áº£nh hÆ°á»Ÿng)

**Part B â€” Security Hardening:**
- [x] Middleware thá»±c sá»± cháº¡y (file Ä‘Æ°á»£c Ä‘áº·t tÃªn Ä‘Ãºng `middleware.ts`)
- [x] NgÆ°á»i chÆ°a Ä‘Äƒng nháº­p khÃ´ng thá»ƒ truy cáº­p báº¥t ká»³ trang nÃ o trong `(main)/`
- [x] API Supabase (REST) khÃ´ng tráº£ vá» email/sá»‘ Ä‘iá»‡n thoáº¡i thÃ nh viÃªn khi chÆ°a Ä‘Äƒng nháº­p
- [x] `profiles` table khÃ´ng bá»‹ liá»‡t kÃª anon qua Supabase REST API
- [x] ThÃ nh viÃªn má»›i táº¡o máº·c Ä‘á»‹nh `privacy_level = 1` (members only)
- [x] ThÃ nh viÃªn sá»‘ng cÃ³ contact data Ä‘Æ°á»£c backfill `privacy_level = 1`
- [x] Máº­t kháº©u tá»‘i thiá»ƒu 8 kÃ½ tá»± khi Ä‘Äƒng kÃ½

### File Structure

```text
frontend/
â”œâ”€â”€ supabase/
â”‚   â”œâ”€â”€ config.toml                                      âœ… NEW (8A)
â”‚   â”œâ”€â”€ seed.sql                                         âœ… NEW (8A)
â”‚   â””â”€â”€ migrations/
â”‚       â”œâ”€â”€ 20260224000000_database_setup.sql            âœ… Moved (8A)
â”‚       â”œâ”€â”€ 20260224000001_sprint6_migration.sql         âœ… Moved (8A)
â”‚       â”œâ”€â”€ 20260224000002_cau_duong_migration.sql       âœ… Moved (8A)
â”‚       â”œâ”€â”€ 20260224000003_sprint75_migration.sql        âœ… Moved (8A)
â”‚       â”œâ”€â”€ 20260224000004_storage_setup.sql             âœ… Moved (8A)
â”‚       â””â”€â”€ 20260226000005_security_hardening.sql        âœ… NEW (8B)
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ local-setup.mjs                                  âœ… NEW (8A)
â”œâ”€â”€ src/
â”‚   â””â”€â”€ middleware.ts                                    âœ… Renamed from proxy.ts (8B)
â”œâ”€â”€ package.json                                         âœ… Modified (8A)
â””â”€â”€ .env.local.example                                   âœ… Modified (8A)
```

### Dependencies

- Requires: Docker Desktop running
- Requires: All migrations from Sprint 1-7.5

---

**Status:** âœ… Sprints 1-8 Complete (v1.7.0) | ğŸ”„ Sprint 9 Phase 3 Complete (v2.0.0 pending)

*Updated: 2026-02-26 â€” Sprint 8 complete: Local Development Mode (Supabase CLI + Docker) + Security Hardening (RLS, middleware, privacy defaults). Sprint 9 Phase 1-3 complete: Electron shell, SQLite shim, app icons, GitHub Actions, auto-update, ZIP export/import, first-run wizard.*

---

## ğŸƒ Sprint 9: Standalone Desktop App ğŸ”„ (Phase 3 Complete)

**Dates:** TBD (22â€“34 days estimated)
**Goal:** Báº£n cÃ i Ä‘áº·t "double-click" cho thÃ nh viÃªn phi ká»¹ thuáº­t â€” khÃ´ng cáº§n Node.js, Docker, Supabase, hay terminal
**Version:** v2.0.0
**CTO Review:** âœ… v1 (7 issues resolved) â†’ âœ… v2 Approved with 3 conditions

### Business Context

Target user: ThÃ nh viÃªn dÃ²ng há» khÃ´ng rÃ nh ká»¹ thuáº­t muá»‘n dÃ¹ng app mÃ  khÃ´ng cáº§n cÃ i Ä‘áº·t stack dev.
Approach Ä‘Æ°á»£c chá»n: **Electron + sql.js (WASM SQLite) Shim** â€” zero code change cho 79 data layer functions, offline, single-file DB.

### Architecture: Supabase Client Shim

```
Web mode:    supabase.from('people').select('*') â†’ PostgREST HTTP â†’ PostgreSQL
Desktop mode: supabase.from('people').select('*') â†’ /api/desktop-db â†’ sql.js SQLite
```

Data layer (5 files, 79 functions), hooks (7), pages/components (~40): **KHÃ”NG Äá»”I**.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Browser (Electron Renderer)                              â”‚
â”‚   sqlite-supabase-shim.ts â†’ fetch('/api/desktop-db')    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ HTTP (localhost)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Next.js Server (Node.js)                                 â”‚
â”‚   /api/desktop-db/ â†’ query-builder â†’ sql.js             â”‚
â”‚   /api/media/[...path] â†’ local filesystem               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                   ancestortree.db (SQLite)
```

### Design Limitations (Documented)

- Desktop = **single-user admin** only â€” no multi-user, no RBAC
- Middleware server-side role check bypassed in desktop mode (documented, not a bug)

### CTO-Approved Prerequisites (3 conditions before Phase 2)

| # | Condition | Resolution | Status |
|---|-----------|------------|--------|
| A | sql.js persistence (in-memory, manual flush) | Singleton `getDatabase()` + `flushToDisk()` after every write + debounced flush + `.bak` before migration | âœ… Done (Phase 2) |
| B | Export format base64 won't scale (100MB+) | Switch to **ZIP archive**: `manifest.json` + `media/` folder (adm-zip, pure JS) | âœ… Done (Phase 3) |
| C | sql.js WASM loading in Next.js standalone | Verify Phase 1 (task 1.7) + fallback: sqljs-dist (inline WASM) | âœ… Done (Phase 1) |

### ADRs Required

| ADR | Title | Decision |
|-----|-------|----------|
| ADR-001 | SQLite adapter (sql.js vs better-sqlite3) | sql.js + `DbAdapter` interface for later swap |
| ADR-002 | desktop-db route decomposition | 4 files: route.ts / query-builder.ts / type-coerce.ts / rpc-handlers.ts |
| ADR-003 | Media export format | ZIP archive (not base64 JSON) |
| ADR-004 | `output: standalone` conditional | `process.env.ELECTRON_BUILD ? 'standalone' : undefined` |

### Phases

#### Phase 1: Electron Shell + Desktop Mode (2â€“3 ngÃ y)

| # | Task | File | Status |
|---|------|------|--------|
| 1.1 | Electron + sql.js + electron-builder deps | `desktop/package.json` | âœ… |
| 1.2 | BrowserWindow, app lifecycle, migration runner | `desktop/electron/main.ts` | âœ… |
| 1.3 | Spawn Next.js standalone on random port | `desktop/electron/server.ts` | âœ… |
| 1.4 | Minimal context bridge | `desktop/electron/preload.ts` | âœ… |
| 1.5 | `output: 'standalone'` conditional | `frontend/next.config.ts` | âœ… |
| 1.6 | 3-line desktop bypass | `frontend/src/middleware.ts` | âœ… |
| **1.7** | **Verify sql.js WASM loads in standalone** (CTO condition C) | `public/` or `outputFileTracingIncludes` | âœ… |
| Gate | Electron launches â†’ shows web app shell | | âœ… |

#### Phase 2: SQLite Shim â€” Core (12â€“18 ngÃ y)

| # | Task | File | Lines | Status |
|---|------|------|-------|--------|
| 2.1 | Mock 8 auth methods | `sqlite-auth-shim.ts` | ~80 | âœ… |
| 2.2 | Storage â†’ API routes serializer | `sqlite-storage-shim.ts` | ~80 | âœ… |
| 2.3 | Client query builder â†’ JSON â†’ fetch | `sqlite-supabase-shim.ts` | ~120 | âœ… |
| 2.4 | SQL executor: query-builder + type-coerce + rpc-handlers (ADR-002) | `api/desktop-db/` (4 files) | ~500 | âœ… |
| **2.4a** | **Singleton DB + `flushToDisk()` after every write** (CTO condition A) | `api/desktop-db/query-builder.ts` | ~50 | âœ… |
| 2.5 | Local file server + path traversal guard | `api/media/[...path]/route.ts` | ~50 | âœ… |
| 2.6 | Return shim in desktop mode | `frontend/src/lib/supabase.ts` | ~12 | âœ… |
| 2.7 | SQLite schema (13 tables, PGâ†’SQLite types) | `sqlite-migrations/001_initial.sql` | ~200 | âœ… |
| 2.8 | Migration runner + `_migrations` table | `desktop/migrations/` | ~50 | âœ… |
| 2.9 | Integration tests: all 79 functions vs SQLite | `__tests__/shim-integration.test.ts` | ~300 | â³ |
| Gate | All 79 functions pass, 13 routes working, CRUD + tree + cáº§u Ä‘Æ°Æ¡ng | | | ğŸ”„ |

#### Phase 3: Build & Distribution (5â€“8 ngÃ y)

| # | Task | File | Status |
|---|------|------|--------|
| 3.1 | macOS .dmg, Windows .exe (NSIS), Linux .AppImage | `electron-builder.yml` | âœ… |
| 3.2 | App icons (3 formats) | `desktop/build/icon.*` | âœ… |
| 3.3 | First-run wizard (tÃªn dÃ²ng há», admin, import) | `(main)/setup/page.tsx` | âœ… |
| **3.4** | **ZIP export format** (CTO condition B) | Export/Import engine | âœ… |
| 3.5 | Code signing: macOS Apple Developer ($99/yr) | electron-builder.yml | â¸ Deferred |
| 3.6 | Test installers on clean machine: macOS + Windows + Linux | | â³ |
| Gate | Install on clean machine â†’ first-run wizard â†’ full app working | | â³ |

#### Phase 4: Polish & Documentation (3â€“5 ngÃ y)

| # | Task | Status |
|---|------|--------|
| 4.1 | Auto-update (electron-updater + GitHub Releases) | âœ… |
| 4.2 | Error handling, graceful shutdown, crash recovery | â³ |
| 4.3 | Update SDLC docs (BRD, TDD, Sprint Plan, Roadmap) | ğŸ”„ |
| 4.4 | User guide tiáº¿ng Viá»‡t | â³ |
| 4.5 | GitHub Release vá»›i binaries (3 platforms) | ğŸ”„ Workflow ready, push tag to trigger |

### Files Changed

**Modified (3 files):**

| File | Lines changed |
|------|---------------|
| `frontend/next.config.ts` | +1 (output: standalone conditional) |
| `frontend/src/middleware.ts` | +3 (desktop bypass) |
| `frontend/src/lib/supabase.ts` | +~12 (shim conditional) |

**New Files (~15 files, ~1,800 lines):**

```
frontend/src/lib/
  sqlite-supabase-shim.ts     (~120) Client query builder
  sqlite-auth-shim.ts         (~80)  Mock auth
  sqlite-storage-shim.ts      (~80)  Storage â†’ API
frontend/src/app/api/
  desktop-db/
    route.ts                  (~80)  HTTP handler
    query-builder.ts          (~200) SQL builder + DB singleton + flush
    type-coerce.ts            (~80)  Boolean/JSONB/UUID
    error-mapper.ts           (~40)  PGRST116 shapes
    rpc-handlers.ts           (~100) is_person_in_subtree CTE
  media/[...path]/route.ts    (~50)  Local file server
frontend/sqlite-migrations/
  001_initial.sql             (~200) 13 tables SQLite
frontend/src/app/(main)/setup/page.tsx  (~100) First-run wizard
frontend/src/lib/__tests__/
  shim-integration.test.ts    (~300) 79 function coverage
desktop/
  electron/main.ts            (~120)
  electron/server.ts          (~80)
  electron/preload.ts         (~10)
  package.json                (~40)
  tsconfig.json               (~15)
  electron-builder.yml        (~40)
  migrations/001_initial.sql + runner (~50)
docs/02-design/ADR/           ADR-001 ~ ADR-004
```

**Unchanged:** All 50+ data layer, hooks, pages, components files.

### Acceptance Criteria

- [ ] Double-click installer (.dmg / .exe) installs and opens app
- [ ] First-run wizard: nháº­p tÃªn dÃ²ng há» + admin â†’ app immediately usable
- [ ] Táº¥t cáº£ 13 routes hoáº¡t Ä‘á»™ng offline (khÃ´ng cÃ³ internet)
- [ ] CRUD people/families/events/achievements/fund/cáº§u Ä‘Æ°Æ¡ng hoáº¡t Ä‘á»™ng
- [ ] CÃ¢y gia pháº£ + tÃ¬m kiáº¿m hoáº¡t Ä‘á»™ng
- [ ] Export ZIP â†’ Import vÃ o web instance (data + media intact)
- [ ] Dá»¯ liá»‡u persist sau restart (`ancestortree.db`)
- [ ] Migration: install v1 â†’ add data â†’ update v2 â†’ data preserved
- [ ] `pnpm build` (web mode) váº«n pass
- [ ] macOS install khÃ´ng cÃ³ Gatekeeper warning

### Estimate

| Phase | Duration |
|-------|----------|
| Phase 1 | 2â€“3 ngÃ y |
| Phase 2 | 12â€“18 ngÃ y |
| Phase 3 | 5â€“8 ngÃ y |
| Phase 4 | 3â€“5 ngÃ y |
| **Total** | **22â€“34 ngÃ y** |

*SDLC Framework 6.1.1 - Stage 04 Build*
